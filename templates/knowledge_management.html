<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Management - Shiftwork Solutions AI Swarm</title>
    <!--
        Last Updated: February 27, 2026

        CHANGES - February 27, 2026 (Session 3):
          * REMOVED mandatory Document Type selection.
            PROBLEM: Users were required to pick one document type for all queued
            files, which made no sense when uploading a batch of mixed types
            (lessons learned, Pillar docs, contracts, etc.).
            SOLUTION:
            - Added detectDocumentType(filename) that auto-detects type from
              filename keywords and extension. Mirrors _detect_document_type()
              in routes/ingest.py exactly.
            - Each file in the queue is tagged with its auto-detected type
              (stored in fileQueue as objects: {file, detectedType}).
            - Queue render shows detected type as a small badge next to each file.
            - "Document Type" dropdown changed from required to optional override:
              if user selects a type it overrides ALL files; if left blank each
              file uses its auto-detected type.
            - uploadSingle() uses detectedType from the file object unless
              dropdown is set.
            - uploadBatch() sends 'document_types' as a JSON array (one per file)
              to /api/ingest/batch, which now accepts per-file types.
            - Batch results table shows detected type for each file.
            - Removed required validation on document type field.

        CHANGES - February 27, 2026 (Session 2):
          * ADDED multi-file support. Drop zone accepts multiple files.
            fileQueue array replaces single selectedFile.
            Routes to /api/ingest/batch for 2+ files.

        CHANGES - February 26, 2026 (second update):
          * FIXED: After upload, clicking Choose File did nothing.

        CHANGES - February 26, 2026 (first update):
          * Added all new document types, full industry list, highlights panel.

        CHANGES - February 22, 2026:
          * Fixed Download Knowledge button, added PowerPoint support.
    -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p { font-size: 1.1em; opacity: 0.9; }

        .header-nav {
            position: absolute;
            top: 0; right: 0;
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .nav-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.3); }

        .stat-card h3 {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value { font-size: 2.5em; font-weight: 700; color: #667eea; margin-bottom: 5px; }
        .stat-card .label { font-size: 0.9em; color: #999; }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-zone.dragover { background: #e8ebff; border-color: #764ba2; transform: scale(1.02); }
        .upload-zone:hover { background: #e8ebff; }
        .upload-icon { font-size: 3em; margin-bottom: 10px; }
        .upload-zone h3 { color: #667eea; margin-bottom: 8px; font-size: 1.2em; }
        .upload-zone p { color: #666; margin-bottom: 15px; font-size: 0.88em; line-height: 1.5; }
        .file-input { display: none; }

        /* File queue */
        .queue-header {
            font-weight: 700;
            color: #333;
            font-size: 0.95em;
            margin-bottom: 8px;
            width: 100%;
            text-align: left;
        }

        .queue-list {
            width: 100%;
            max-height: 220px;
            overflow-y: auto;
            margin-bottom: 4px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: white;
            border: 1px solid #e0e8ff;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 0.87em;
            text-align: left;
        }

        .queue-icon { font-size: 1.15em; flex-shrink: 0; }

        .queue-name {
            flex: 1;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Auto-detected type badge shown in queue */
        .queue-type-badge {
            background: #e8ebff;
            color: #667eea;
            font-size: 0.78em;
            font-weight: 600;
            padding: 2px 7px;
            border-radius: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .queue-size { color: #aaa; flex-shrink: 0; font-size: 0.85em; }

        .queue-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.95em;
            padding: 1px 5px;
            flex-shrink: 0;
            border-radius: 3px;
            transition: background 0.2s;
            line-height: 1;
        }

        .queue-remove:hover { background: #f8d7da; }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.6); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-sm { padding: 8px 18px; font-size: 0.87em; }

        /* Form */
        .form-group { margin-bottom: 20px; }

        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus { outline: none; border-color: #667eea; }

        .form-group .hint { font-size: 0.82em; color: #888; margin-top: 5px; font-style: italic; }

        /* Override note shown under document type dropdown */
        .override-note {
            font-size: 0.82em;
            color: #667eea;
            margin-top: 5px;
            font-style: italic;
        }

        /* Progress */
        .progress {
            background: #f0f0f0;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Highlights panel */
        .highlights-panel {
            background: #f0f4ff;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 15px;
            display: none;
        }

        .highlights-panel h4 {
            color: #667eea;
            font-size: 0.95em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .highlights-panel ul { list-style: none; padding: 0; }

        .highlights-panel li {
            padding: 4px 0;
            font-size: 0.9em;
            color: #333;
            border-bottom: 1px solid #e0e8ff;
        }

        .highlights-panel li:last-child { border-bottom: none; }
        .highlights-panel li::before { content: "‚úì "; color: #667eea; font-weight: bold; }

        /* Batch results */
        .batch-results {
            background: #f8f9ff;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 15px;
            display: none;
        }

        .batch-results h4 {
            color: #667eea;
            font-size: 0.95em;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .batch-results-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }

        .batch-results-table th {
            background: #667eea;
            color: white;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
        }

        .batch-results-table td {
            padding: 7px 10px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }

        .batch-results-table tr:last-child td { border-bottom: none; }
        .batch-results-table tr.row-success td { background: #f0fff4; }
        .batch-results-table tr.row-error   td { background: #fff5f5; }
        .badge-ok   { color: #155724; font-weight: 700; }
        .badge-fail { color: #721c24; font-weight: 700; }

        /* Type label in batch results */
        .type-label {
            background: #e8ebff;
            color: #667eea;
            font-size: 0.78em;
            font-weight: 600;
            padding: 2px 7px;
            border-radius: 10px;
            white-space: nowrap;
        }

        /* Patterns list */
        .patterns-list { max-height: 500px; overflow-y: auto; }

        .pattern-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .pattern-item:hover { border-color: #667eea; background: #f8f9ff; }

        .pattern-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pattern-name { font-weight: 600; color: #333; font-size: 1em; }

        .pattern-type {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            white-space: nowrap;
        }

        .pattern-meta { display: flex; gap: 20px; font-size: 0.85em; color: #666; margin-top: 8px; }

        .confidence-bar { width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .confidence-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.5s ease; }

        /* History */
        .history-list { max-height: 500px; overflow-y: auto; }

        .history-item {
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9ff;
            border-radius: 0 8px 8px 0;
        }

        .history-item .title { font-weight: 600; color: #333; margin-bottom: 5px; }
        .history-item .meta  { font-size: 0.85em; color: #666; }
        .history-item .stats { margin-top: 10px; display: flex; gap: 20px; font-size: 0.9em; }

        .stat-badge { background: white; padding: 4px 10px; border-radius: 6px; color: #667eea; font-weight: 600; }

        /* Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Celebration */
        .celebration {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            text-align: center;
            z-index: 1000;
            display: none;
            animation: popIn 0.5s ease;
            max-width: 520px;
            width: 90%;
        }

        @keyframes popIn {
            0%   { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .celebration h2    { color: #667eea; font-size: 2em; margin-bottom: 10px; }
        .celebration .icon { font-size: 5em; margin-bottom: 20px; }

        .celebration .highlights {
            text-align: left;
            background: #f8f9ff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .celebration .highlights li { list-style: none; padding: 3px 0; color: #333; border-bottom: 1px solid #e8ebff; }
        .celebration .highlights li:last-child { border-bottom: none; }
        .celebration .highlights li::before { content: "‚úì "; color: #667eea; }

        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        optgroup { font-weight: 700; color: #444; }
        option   { font-weight: 400; color: #333; }

        @media (max-width: 768px) {
            .main-grid  { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .header h1  { font-size: 1.8em; }
            .card       { padding: 20px; }
            .header-nav { position: static; justify-content: center; margin-top: 20px; }
        }
    </style>
</head>
<body>
<div class="container">

    <div class="header">
        <div class="header-nav">
            <a href="/" class="nav-btn">&#8592; Back to Main</a>
            <button class="nav-btn" id="downloadBtn" onclick="downloadKnowledge(this)">
                &#128229; Download Knowledge
            </button>
            <button class="nav-btn" id="clearBtn" onclick="clearKnowledgeBase(this)"
                    style="background:#dc3545;color:#fff;border:none;cursor:pointer;">
                &#128465;&#65039; Clear Knowledge Base
            </button>
        </div>
        <h1>&#129504; Knowledge Management</h1>
        <p>Shoulders of Giants - Cumulative Learning System</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Documents</h3>
            <div class="value" id="totalDocs">0</div>
            <div class="label">ingested forever</div>
        </div>
        <div class="stat-card">
            <h3>Learned Patterns</h3>
            <div class="value" id="totalPatterns">0</div>
            <div class="label">growing stronger</div>
        </div>
        <div class="stat-card">
            <h3>Implementation Manuals</h3>
            <div class="value" id="implDocs">0</div>
            <div class="label">client projects</div>
        </div>
        <div class="stat-card">
            <h3>Lessons Learned</h3>
            <div class="value" id="lessonDocs">0</div>
            <div class="label">consulting wisdom</div>
        </div>
        <div class="stat-card">
            <h3>Contracts</h3>
            <div class="value" id="contractDocs">0</div>
            <div class="label">engagement terms</div>
        </div>
        <div class="stat-card">
            <h3>Assessments</h3>
            <div class="value" id="assessmentDocs">0</div>
            <div class="label">OAF + EAF combined</div>
        </div>
    </div>

    <div class="main-grid">

        <!-- Upload Section -->
        <div class="card">
            <h2>&#128228; Upload Document</h2>

            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error"   id="errorAlert"></div>

            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">&#128196;</div>
                <h3>Drag &amp; Drop Documents</h3>
                <p>Word (.docx), Excel (.xlsx), PowerPoint (.pptx), PDF, Text, Markdown, CSV<br>
                   <em>Multiple files supported &#8212; type is auto-detected from filename</em></p>
                <button class="btn" type="button">Choose Files</button>
            </div>
            <!-- fileInput outside uploadZone to prevent nested-click issues -->
            <input type="file" id="fileInput" class="file-input" multiple
                   accept=".txt,.md,.pdf,.docx,.doc,.xlsx,.xls,.csv,.json,.pptx,.ppt">

            <div class="progress" id="uploadProgress">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <!-- Highlights (single file) -->
            <div class="highlights-panel" id="highlightsPanel">
                <h4>&#128203; What Was Extracted</h4>
                <ul id="highlightsList"></ul>
            </div>

            <!-- Batch results table -->
            <div class="batch-results" id="batchResults">
                <h4>&#128203; Batch Results</h4>
                <table class="batch-results-table">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Detected Type</th>
                            <th>Status</th>
                            <th>Patterns</th>
                            <th>Insights</th>
                        </tr>
                    </thead>
                    <tbody id="batchResultsBody"></tbody>
                </table>
            </div>

            <form id="uploadForm" style="margin-top:25px;">

                <!--
                    Document Type is now OPTIONAL and acts as a manual override.
                    If left blank, each file's type is auto-detected from its filename.
                    If set, it overrides all files in the batch.
                -->
                <div class="form-group">
                    <label for="documentType">Document Type Override (optional)</label>
                    <select id="documentType">
                        <option value="">&#8212; Auto-Detect from Filename (recommended) &#8212;</option>

                        <optgroup label="-- Word Documents --">
                            <option value="contract">Contract / Engagement Agreement</option>
                            <option value="implementation_manual">Implementation Manual</option>
                            <option value="lessons_learned">Lessons Learned</option>
                            <option value="scope_of_work">Scope of Work</option>
                            <option value="general_word">General Word Document</option>
                        </optgroup>

                        <optgroup label="-- PowerPoint Presentations --">
                            <option value="oaf">Operations Assessment (OAF)</option>
                            <option value="eaf">Employee Assessment (EAF)</option>
                            <option value="implementation_ppt">Implementation Presentation</option>
                        </optgroup>

                        <optgroup label="-- Excel Files --">
                            <option value="schedule_pattern">Schedule Pattern File</option>
                            <option value="data_file">Data File (Labor / Overtime / Cost)</option>
                        </optgroup>
                    </select>
                    <div class="override-note" id="overrideNote">
                        &#128269; Type auto-detected per file. Select above only to override all files.
                    </div>
                </div>

                <div class="form-group">
                    <label for="clientName">Client Name (optional)</label>
                    <input type="text" id="clientName"
                           placeholder="e.g., Andersen, ChemDesign, Reckitt">
                </div>

                <div class="form-group">
                    <label for="industry">Industry (optional)</label>
                    <select id="industry">
                        <option value="">- Select Industry -</option>
                        <optgroup label="-- Process Industries --">
                            <option value="chemical">Chemical</option>
                            <option value="pharmaceutical">Pharmaceutical</option>
                            <option value="food_processing">Food Processing</option>
                            <option value="refinery">Refinery / Petroleum</option>
                            <option value="oil_gas">Oil &amp; Gas</option>
                            <option value="plastics">Plastics / Rubber</option>
                            <option value="paper_pulp">Paper / Pulp</option>
                        </optgroup>
                        <optgroup label="-- Manufacturing --">
                            <option value="manufacturing">General Manufacturing</option>
                            <option value="automotive">Automotive</option>
                            <option value="aerospace">Aerospace / Defense</option>
                            <option value="metals">Metals / Steel</option>
                            <option value="electronics">Electronics</option>
                        </optgroup>
                        <optgroup label="-- Extraction &amp; Energy --">
                            <option value="mining">Mining</option>
                            <option value="utilities">Utilities / Power</option>
                        </optgroup>
                        <optgroup label="-- Other --">
                            <option value="distribution">Distribution / Warehousing</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="other">Other</option>
                        </optgroup>
                    </select>
                </div>

                <button type="submit" class="btn" id="submitBtn" style="width:100%;">
                    &#128640; Ingest Document
                </button>
            </form>

            <div class="spinner" id="spinner"></div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <h2>&#128202; Recent Ingestions</h2>
            <div class="history-list" id="historyList">
                <p style="text-align:center;color:#999;padding:40px;">Loading recent activity...</p>
            </div>
        </div>
    </div>

    <!-- Patterns -->
    <div class="card" style="margin-bottom:30px;">
        <h2>&#127919; Learned Patterns</h2>
        <div class="patterns-list" id="patternsList">
            <p style="text-align:center;color:#999;padding:40px;">Loading patterns...</p>
        </div>
    </div>

</div>

<div class="overlay"     id="overlay"></div>
<div class="celebration" id="celebration">
    <div class="icon">&#127881;</div>
    <h2 id="celebrationTitle">Knowledge Extracted!</h2>
    <p  id="celebrationMessage"></p>
    <ul class="highlights" id="celebrationHighlights" style="display:none;"></ul>
</div>

<script>
// ===========================================================================
// AUTO-DETECT DOCUMENT TYPE FROM FILENAME
// Mirrors _detect_document_type() in routes/ingest.py exactly.
// Added February 27, 2026 (Session 3).
// ===========================================================================
function detectDocumentType(filename) {
    var name = filename.toLowerCase();
    var ext  = name.indexOf('.') !== -1 ? name.split('.').pop() : '';

    if (ext === 'pptx' || ext === 'ppt') {
        if (name.indexOf('oaf') !== -1 || name.indexOf('operations') !== -1) return 'oaf';
        if (name.indexOf('eaf') !== -1 || name.indexOf('employee') !== -1 || name.indexOf('survey') !== -1) return 'eaf';
        return 'implementation_ppt';
    }

    if (ext === 'xlsx' || ext === 'xls') {
        if (name.indexOf('schedule') !== -1 || name.indexOf('pattern') !== -1) return 'schedule_pattern';
        return 'data_file';
    }

    if (ext === 'docx' || ext === 'doc') {
        if (name.indexOf('lesson') !== -1)                                           return 'lessons_learned';
        // NOTE: 'engagement' alone does NOT indicate a contract.
        // Pillar_7_Employee_Engagement is a consulting guide, not a legal document.
        // Require 'contract' or 'agreement' explicitly in the filename.
        if (name.indexOf('contract') !== -1 || name.indexOf('agreement') !== -1)     return 'contract';
        if (name.indexOf('proposal') !== -1)                                          return 'contract';
        if (name.indexOf('scope') !== -1)                                             return 'scope_of_work';
        if (name.indexOf('implementation') !== -1 && name.indexOf('manual') !== -1)   return 'implementation_manual';
        return 'general_word';
    }

    if (ext === 'pdf') {
        if (name.indexOf('lesson') !== -1)                                           return 'lessons_learned';
        if (name.indexOf('contract') !== -1 || name.indexOf('agreement') !== -1)     return 'contract';
        return 'generic';
    }

    return 'generic';
}

// Human-readable labels for type badges
var TYPE_LABELS = {
    'lessons_learned':       'Lessons Learned',
    'contract':              'Contract',
    'scope_of_work':         'Scope of Work',
    'implementation_manual': 'Impl. Manual',
    'general_word':          'General Word',
    'oaf':                   'OAF',
    'eaf':                   'EAF',
    'implementation_ppt':    'Impl. PPT',
    'schedule_pattern':      'Schedule Pattern',
    'data_file':             'Data File',
    'excel':                 'Excel',
    'generic':               'Generic'
};

function typeLabel(t) { return TYPE_LABELS[t] || t; }

// ===========================================================================
// FILE QUEUE STATE
// Each entry: { file: File, detectedType: string }
// ===========================================================================
var fileQueue = [];

// ===========================================================================
// INITIALIZE
// ===========================================================================
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadHistory();
    loadPatterns();
    setupDragDrop();
    setupFormSubmit();
    setupOverrideNote();
});

// Update override note when dropdown changes
function setupOverrideNote() {
    var sel  = document.getElementById('documentType');
    var note = document.getElementById('overrideNote');
    sel.addEventListener('change', function() {
        if (this.value) {
            note.innerHTML = '&#9888;&#65039; Override active: all files will be ingested as <strong>' +
                typeLabel(this.value) + '</strong>.';
            note.style.color = '#e67e00';
        } else {
            note.innerHTML = '&#128269; Type auto-detected per file. Select above only to override all files.';
            note.style.color = '#667eea';
        }
    });
}

// ===========================================================================
// DRAG & DROP
// ===========================================================================
function setupDragDrop() {
    var uploadZone = document.getElementById('uploadZone');
    var fileInput  = document.getElementById('fileInput');

    uploadZone.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('queue-remove')) return;
        fileInput.value = '';
        fileInput.click();
    });

    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function() {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            addFilesToQueue(Array.from(e.dataTransfer.files));
        }
    });

    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            addFilesToQueue(Array.from(e.target.files));
        }
    });
}

// ===========================================================================
// FILE QUEUE MANAGEMENT
// ===========================================================================
function addFilesToQueue(files) {
    var allowed = {'txt':1,'md':1,'pdf':1,'docx':1,'doc':1,'xlsx':1,'xls':1,'csv':1,'json':1,'pptx':1,'ppt':1};
    var skipped = 0;

    files.forEach(function(file) {
        var ext = file.name.indexOf('.') !== -1 ? file.name.split('.').pop().toLowerCase() : '';
        if (!allowed[ext]) { skipped++; return; }

        // Deduplicate by name + size
        var exists = fileQueue.some(function(q) { return q.file.name === file.name && q.file.size === file.size; });
        if (!exists) {
            fileQueue.push({ file: file, detectedType: detectDocumentType(file.name) });
        }
    });

    if (skipped > 0) showError(skipped + ' file(s) skipped ‚Äî unsupported file type.');
    renderFileQueue();
}

function removeFromQueue(index, event) {
    if (event) event.stopPropagation();
    fileQueue.splice(index, 1);
    renderFileQueue();
}

function renderFileQueue() {
    var icons = {'pptx':'üìä','ppt':'üìä','xlsx':'üìà','xls':'üìà','pdf':'üìï','docx':'üìù','doc':'üìù','md':'üìÑ','csv':'üìä','txt':'üìÑ','json':'üìÑ'};
    var zone  = document.getElementById('uploadZone');

    if (fileQueue.length === 0) {
        zone.innerHTML =
            '<div class="upload-icon">&#128196;</div>' +
            '<h3>Drag &amp; Drop Documents</h3>' +
            '<p>Word (.docx), Excel (.xlsx), PowerPoint (.pptx), PDF, Text, Markdown, CSV<br>' +
            '<em>Multiple files supported &#8212; type is auto-detected from filename</em></p>' +
            '<button class="btn" type="button">Choose Files</button>';
        var sb = document.getElementById('submitBtn');
        if (sb) sb.textContent = '\uD83D\uDE80 Ingest Document';
        return;
    }

    // Check for manual override
    var overrideType = document.getElementById('documentType').value;

    var items = fileQueue.map(function(q, i) {
        var ext      = q.file.name.indexOf('.') !== -1 ? q.file.name.split('.').pop().toLowerCase() : '';
        var icon     = icons[ext] || 'üìÑ';
        var kb       = (q.file.size / 1024).toFixed(1);
        var dispType = overrideType || q.detectedType;
        return '<div class="queue-item">' +
            '<span class="queue-icon">' + icon + '</span>' +
            '<span class="queue-name" title="' + escapeHtml(q.file.name) + '">' + escapeHtml(q.file.name) + '</span>' +
            '<span class="queue-type-badge">' + escapeHtml(typeLabel(dispType)) + '</span>' +
            '<span class="queue-size">' + kb + ' KB</span>' +
            '<button class="queue-remove" type="button" onclick="removeFromQueue(' + i + ', event)">\u2715</button>' +
            '</div>';
    }).join('');

    var plural = fileQueue.length !== 1 ? 's' : '';
    zone.innerHTML =
        '<div class="queue-header">' + fileQueue.length + ' file' + plural + ' queued for ingestion</div>' +
        '<div class="queue-list">' + items + '</div>' +
        '<button class="btn btn-sm" type="button" style="margin-top:8px;">\u2795 Add More Files</button>';

    var submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.textContent = fileQueue.length === 1
            ? '\uD83D\uDE80 Ingest Document'
            : '\uD83D\uDE80 Ingest ' + fileQueue.length + ' Documents';
    }
}

// Re-render queue when override changes so badges update immediately
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('documentType').addEventListener('change', function() {
        if (fileQueue.length > 0) renderFileQueue();
    });
});

// ===========================================================================
// FORM SUBMISSION
// ===========================================================================
function setupFormSubmit() {
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (fileQueue.length === 0) { showError('Please select at least one file first'); return; }
        await uploadDocuments();
    });
}

// ===========================================================================
// UPLOAD ORCHESTRATION
// ===========================================================================
async function uploadDocuments() {
    document.getElementById('spinner').style.display        = 'block';
    document.getElementById('submitBtn').disabled            = true;
    document.getElementById('uploadProgress').style.display  = 'block';
    document.getElementById('highlightsPanel').style.display = 'none';
    document.getElementById('batchResults').style.display    = 'none';

    var progress = 0;
    var progressInterval = setInterval(function() {
        progress += 5;
        if (progress <= 90) document.getElementById('progressBar').style.width = progress + '%';
    }, 100);

    try {
        var data;
        if (fileQueue.length === 1) {
            data = await uploadSingle(fileQueue[0]);
        } else {
            data = await uploadBatch();
        }

        clearInterval(progressInterval);
        document.getElementById('progressBar').style.width = '100%';

        setTimeout(function() {
            document.getElementById('spinner').style.display        = 'none';
            document.getElementById('submitBtn').disabled            = false;
            document.getElementById('uploadProgress').style.display  = 'none';
            document.getElementById('progressBar').style.width       = '0%';

            if (data.batch) {
                handleBatchResult(data);
            } else {
                handleSingleResult(data);
            }
        }, 500);

    } catch (error) {
        clearInterval(progressInterval);
        document.getElementById('spinner').style.display        = 'none';
        document.getElementById('submitBtn').disabled            = false;
        document.getElementById('uploadProgress').style.display  = 'none';
        showError('Upload failed: ' + error.message);
    }
}

// Single file: use detected type unless manual override is set
async function uploadSingle(queueEntry) {
    var overrideType = document.getElementById('documentType').value;
    var docType      = overrideType || queueEntry.detectedType;

    var formData = new FormData();
    formData.append('file',          queueEntry.file);
    formData.append('document_type', docType);
    formData.append('client',        document.getElementById('clientName').value);
    formData.append('industry',      document.getElementById('industry').value);

    var response = await fetch('/api/ingest/document', { method: 'POST', body: formData });
    return await response.json();
}

// Batch: send per-file detected types as JSON array
async function uploadBatch() {
    var overrideType = document.getElementById('documentType').value;

    // Build per-file type array: override wins, else auto-detected
    var perFileTypes = fileQueue.map(function(q) {
        return overrideType || q.detectedType;
    });

    var formData = new FormData();
    fileQueue.forEach(function(q) { formData.append('files', q.file); });
    formData.append('document_types', JSON.stringify(perFileTypes));
    formData.append('document_type',  overrideType);   // global fallback
    formData.append('client',         document.getElementById('clientName').value);
    formData.append('industry',       document.getElementById('industry').value);

    var response = await fetch('/api/ingest/batch', { method: 'POST', body: formData });
    return await response.json();
}

// ===========================================================================
// RESULT HANDLERS
// ===========================================================================
function handleSingleResult(data) {
    if (data.success) {
        showSuccess(data.message || 'Document ingested successfully');
        showHighlights(data.highlights || []);
        showCelebration(data);
        resetForm();
        loadStats(); loadHistory(); loadPatterns();
    } else {
        showError(data.error || 'Upload failed');
    }
}

function handleBatchResult(data) {
    if (data.success_count > 0) {
        showSuccess(
            data.success_count + ' of ' + data.total_files + ' files ingested. ' +
            data.total_patterns_extracted + ' patterns, ' +
            data.total_insights_extracted + ' insights extracted.'
        );
    }
    if (data.error_count > 0) {
        showError(data.error_count + ' file(s) failed ‚Äî see results table below.');
    }
    showBatchResults(data.results || []);
    showCelebrationBatch(data);
    resetForm();
    loadStats(); loadHistory(); loadPatterns();
}

// ===========================================================================
// HIGHLIGHTS (single file)
// ===========================================================================
function showHighlights(highlights) {
    var panel = document.getElementById('highlightsPanel');
    var list  = document.getElementById('highlightsList');
    if (!highlights || highlights.length === 0) { panel.style.display = 'none'; return; }
    list.innerHTML = highlights.map(function(h) { return '<li>' + escapeHtml(h) + '</li>'; }).join('');
    panel.style.display = 'block';
}

// ===========================================================================
// BATCH RESULTS TABLE ‚Äî now includes Detected Type column
// ===========================================================================
function showBatchResults(results) {
    var panel = document.getElementById('batchResults');
    var tbody = document.getElementById('batchResultsBody');
    if (!results || results.length === 0) { panel.style.display = 'none'; return; }

    tbody.innerHTML = results.map(function(r) {
        var rowClass = r.success ? 'row-success' : 'row-error';
        var status   = r.success
            ? '<span class="badge-ok">\u2713 OK</span>'
            : '<span class="badge-fail">\u2717 ' + escapeHtml(r.error || 'failed') + '</span>';
        var patterns = r.success ? (r.patterns_extracted  || 0) : '&mdash;';
        var insights = r.success ? (r.insights_extracted  || 0) : '&mdash;';
        var dtype    = r.detected_type || '';
        return '<tr class="' + rowClass + '">' +
            '<td>' + escapeHtml(r.filename || '') + '</td>' +
            '<td><span class="type-label">' + escapeHtml(typeLabel(dtype)) + '</span></td>' +
            '<td>' + status   + '</td>' +
            '<td>' + patterns + '</td>' +
            '<td>' + insights + '</td>' +
            '</tr>';
    }).join('');

    panel.style.display = 'block';
}

// ===========================================================================
// CELEBRATION
// ===========================================================================
function showCelebration(data) {
    document.getElementById('celebrationTitle').textContent = 'Knowledge Extracted!';
    document.getElementById('celebrationMessage').innerHTML =
        (data.patterns_extracted || 0) + ' patterns extracted &nbsp; ' +
        '\uD83D\uDCA1 ' + (data.insights_extracted || 0) + ' insights captured &nbsp; ' +
        '\uD83D\uDCCA ' + (data.total_patterns || 0) + ' total patterns in knowledge base';

    var hl  = document.getElementById('celebrationHighlights');
    var hls = data.highlights || [];
    if (hls.length > 0) {
        hl.innerHTML = hls.map(function(h) { return '<li>' + escapeHtml(h) + '</li>'; }).join('');
        hl.style.display = 'block';
    } else {
        hl.style.display = 'none';
    }
    _showCelebrationPopup();
}

function showCelebrationBatch(data) {
    if (!data.success_count || data.success_count === 0) return;
    document.getElementById('celebrationTitle').textContent = data.success_count + ' Files Ingested!';
    document.getElementById('celebrationMessage').innerHTML =
        '\uD83D\uDCC1 ' + data.success_count + ' of ' + data.total_files + ' files succeeded &nbsp; ' +
        '\uD83D\uDCCA ' + (data.total_patterns_extracted || 0) + ' patterns extracted &nbsp; ' +
        '\uD83D\uDCA1 ' + (data.total_insights_extracted || 0) + ' insights captured';
    document.getElementById('celebrationHighlights').style.display = 'none';
    _showCelebrationPopup();
}

function _showCelebrationPopup() {
    document.getElementById('overlay').style.display     = 'block';
    document.getElementById('celebration').style.display = 'block';
    setTimeout(function() {
        document.getElementById('overlay').style.display     = 'none';
        document.getElementById('celebration').style.display = 'none';
    }, 4000);
}

// ===========================================================================
// RESET FORM
// ===========================================================================
function resetForm() {
    fileQueue = [];
    document.getElementById('uploadForm').reset();
    // Reset override note
    document.getElementById('overrideNote').innerHTML =
        '&#128269; Type auto-detected per file. Select above only to override all files.';
    document.getElementById('overrideNote').style.color = '#667eea';
    document.getElementById('uploadZone').innerHTML =
        '<div class="upload-icon">&#128196;</div>' +
        '<h3>Drag &amp; Drop Documents</h3>' +
        '<p>Word (.docx), Excel (.xlsx), PowerPoint (.pptx), PDF, Text, Markdown, CSV<br>' +
        '<em>Multiple files supported &#8212; type is auto-detected from filename</em></p>' +
        '<button class="btn" type="button">Choose Files</button>';
    var sb = document.getElementById('submitBtn');
    if (sb) sb.textContent = '\uD83D\uDE80 Ingest Document';
}

// ===========================================================================
// STATS / HISTORY / PATTERNS
// ===========================================================================
async function loadStats() {
    try {
        var response = await fetch('/api/ingest/status');
        var data = await response.json();
        if (data.success) {
            var stats  = data.stats;
            var byType = stats.by_document_type || {};
            document.getElementById('totalDocs').textContent     = stats.total_extracts;
            document.getElementById('totalPatterns').textContent  = stats.total_patterns;
            document.getElementById('implDocs').textContent       = byType.implementation_manual || 0;
            document.getElementById('lessonDocs').textContent     = byType.lessons_learned || 0;
            document.getElementById('contractDocs').textContent   = (byType.contract || 0) + (byType.proposal || 0);
            document.getElementById('assessmentDocs').textContent = (byType.oaf || 0) + (byType.eaf || 0);
        }
    } catch (e) { console.error('Failed to load stats:', e); }
}

async function loadHistory() {
    try {
        var response = await fetch('/api/ingest/history?limit=10');
        var data = await response.json();
        if (data.success) {
            var el = document.getElementById('historyList');
            if (data.history.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No documents ingested yet</p>';
                return;
            }
            el.innerHTML = data.history.map(function(item) {
                return '<div class="history-item">' +
                    '<div class="title">' + escapeHtml(item.document_name) + '</div>' +
                    '<div class="meta">' + escapeHtml(item.document_type) + ' &bull; ' + new Date(item.ingested_at).toLocaleString() + '</div>' +
                    '<div class="stats">' +
                    '<span class="stat-badge">\uD83D\uDCCA ' + item.patterns_extracted + ' patterns</span>' +
                    '<span class="stat-badge">\uD83D\uDCA1 ' + item.insights_extracted + ' insights</span>' +
                    '</div></div>';
            }).join('');
        }
    } catch (e) { console.error('Failed to load history:', e); }
}

async function loadPatterns() {
    try {
        var response = await fetch('/api/ingest/patterns?limit=30');
        var data = await response.json();
        if (data.success) {
            var el = document.getElementById('patternsList');
            if (data.patterns.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No patterns learned yet</p>';
                return;
            }
            el.innerHTML = data.patterns.map(function(p) {
                var pct = (p.confidence * 100).toFixed(1);
                return '<div class="pattern-item">' +
                    '<div class="pattern-header">' +
                    '<span class="pattern-name">' + escapeHtml(p.pattern_name || '') + '</span>' +
                    '<span class="pattern-type">' + escapeHtml(p.pattern_type  || '') + '</span>' +
                    '</div>' +
                    '<div class="confidence-bar"><div class="confidence-fill" style="width:' + pct + '%"></div></div>' +
                    '<div class="pattern-meta">' +
                    '<span>\uD83D\uDCAA ' + pct + '% confidence</span>' +
                    '<span>\uD83D\uDCDA ' + p.supporting_documents + ' doc' + (p.supporting_documents !== 1 ? 's' : '') + '</span>' +
                    '</div></div>';
            }).join('');
        }
    } catch (e) { console.error('Failed to load patterns:', e); }
}

// ===========================================================================
// DOWNLOAD / CLEAR
// ===========================================================================
function downloadKnowledge(btn) {
    btn.disabled = true;
    btn.innerHTML = 'Preparing download...';
    window.location.href = '/api/ingest/export';
    setTimeout(function() { btn.disabled = false; btn.innerHTML = '&#128229; Download Knowledge'; }, 3000);
}

async function clearKnowledgeBase(btn) {
    if (!confirm('‚ö†Ô∏è Clear Knowledge Base?\n\nThis will permanently delete ALL ingested documents, patterns, and history.\n\nClick OK to continue.')) return;
    if (!confirm('üõë FINAL CONFIRMATION\n\nAre you absolutely sure?\n\nAll knowledge extracts and learned patterns will be deleted.\n\nClick OK to permanently clear.')) return;

    btn.disabled = true;
    btn.innerHTML = '‚è≥ Clearing...';

    try {
        var response = await fetch('/api/ingest/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirm: 'CLEAR' })
        });
        var data = await response.json();

        if (data.success) {
            var d = data.deleted || {};
            alert('‚úÖ Knowledge base cleared!\n\nDocuments: ' + (d.knowledge_extracts || 0) +
                  '\nPatterns: ' + (d.learned_patterns || 0) +
                  '\nHistory: '  + (d.ingestion_log    || 0));
            loadStats(); loadHistory();
        } else {
            alert('‚ùå Clear failed: ' + (data.error || 'Unknown error'));
        }
    } catch (err) {
        alert('‚ùå Request failed: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '&#128465;&#65039; Clear Knowledge Base';
    }
}

// ===========================================================================
// UTILITY
// ===========================================================================
function showSuccess(message) {
    var el = document.getElementById('successAlert');
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(function() { el.style.display = 'none'; }, 8000);
}

function showError(message) {
    var el = document.getElementById('errorAlert');
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(function() { el.style.display = 'none'; }, 8000);
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>

<!-- I did no harm and this file is not truncated -->
