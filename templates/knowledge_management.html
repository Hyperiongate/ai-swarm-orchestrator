<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Management - Shiftwork Solutions AI Swarm</title>
    <!--
        Last Updated: February 27, 2026

        CHANGES - February 27, 2026:
          * FIXED: Could not add multiple files. Drag and drop only accepted the
            first file (files[0]). File picker had no 'multiple' attribute.
            No queue existed - selectedFile was a single File object.
          * SOLUTION:
            - selectedFile (single File) replaced with fileQueue (File[] array)
            - addFilesToQueue(File[]) handles deduplication by name+size and
              skips unsupported extensions with a warning
            - removeFromQueue(index, event) removes individual files from queue
            - renderFileQueue() updates the upload zone UI with a scrollable
              list of queued files and an Add More Files button
            - drop handler: Array.from(e.dataTransfer.files) passed to addFilesToQueue
            - fileInput: added multiple attribute; change handler passes all files
            - uploadDocuments() routes to uploadSingle() for 1 file or
              uploadBatch() for 2+ files; batch posts to /api/ingest/batch
            - showBatchResults() renders per-file result table
            - showCelebrationBatch() handles batch celebration popup
          * All single-file functionality preserved: same form fields, same
            document type hints, same highlights panel, same celebration popup.
          * Added CSS: .queue-list, .queue-item, .queue-remove, .queue-header,
            .batch-results, .batch-results-table, .badge-ok, .badge-fail

        CHANGES - February 26, 2026 (second update):
          * FIXED: After uploading, clicking Choose File / Change File did nothing.
            Added click listener on uploadZone and fileInput.value reset.

        CHANGES - February 26, 2026 (first update):
          * Added all new document types to dropdown (scope_of_work, etc.)
          * Added full industry list
          * Added highlights display in celebration popup
          * Document type hints describing what each type extracts

        CHANGES - February 22, 2026:
          * Fixed Download Knowledge button (window.location.href)
          * Added PowerPoint file type support
          * Fixed JavaScript null reference in downloadKnowledge()
    -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p { font-size: 1.1em; opacity: 0.9; }

        .header-nav {
            position: absolute;
            top: 0; right: 0;
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .stat-card h3 {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label { font-size: 0.9em; color: #999; }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* -------------------------------------------------------
           UPLOAD ZONE
           min-height keeps the zone tall even when the queue is
           short. flexbox centers content vertically.
        ------------------------------------------------------- */
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-zone.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-zone:hover { background: #e8ebff; }

        .upload-icon { font-size: 3em; margin-bottom: 10px; }

        .upload-zone h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.2em;
        }

        .upload-zone p {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.88em;
            line-height: 1.5;
        }

        .file-input { display: none; }

        /* -------------------------------------------------------
           FILE QUEUE (rendered inside upload-zone when files
           are selected)
        ------------------------------------------------------- */
        .queue-header {
            font-weight: 700;
            color: #333;
            font-size: 0.95em;
            margin-bottom: 8px;
            width: 100%;
            text-align: left;
        }

        .queue-list {
            width: 100%;
            max-height: 190px;
            overflow-y: auto;
            margin-bottom: 4px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: white;
            border: 1px solid #e0e8ff;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 0.87em;
            text-align: left;
        }

        .queue-icon { font-size: 1.15em; flex-shrink: 0; }

        .queue-name {
            flex: 1;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .queue-size {
            color: #aaa;
            flex-shrink: 0;
            font-size: 0.85em;
        }

        .queue-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.95em;
            padding: 1px 5px;
            flex-shrink: 0;
            border-radius: 3px;
            transition: background 0.2s;
            line-height: 1;
        }

        .queue-remove:hover { background: #f8d7da; }

        /* -------------------------------------------------------
           BUTTONS
        ------------------------------------------------------- */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-sm {
            padding: 8px 18px;
            font-size: 0.87em;
        }

        /* -------------------------------------------------------
           FORM
        ------------------------------------------------------- */
        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group .hint {
            font-size: 0.82em;
            color: #888;
            margin-top: 5px;
            font-style: italic;
        }

        /* -------------------------------------------------------
           PROGRESS BAR
        ------------------------------------------------------- */
        .progress {
            background: #f0f0f0;
            border-radius: 10px;
            height: 8px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* -------------------------------------------------------
           ALERTS
        ------------------------------------------------------- */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info    { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* -------------------------------------------------------
           HIGHLIGHTS PANEL (single file)
        ------------------------------------------------------- */
        .highlights-panel {
            background: #f0f4ff;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 15px;
            display: none;
        }

        .highlights-panel h4 {
            color: #667eea;
            font-size: 0.95em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .highlights-panel ul { list-style: none; padding: 0; }

        .highlights-panel li {
            padding: 4px 0;
            font-size: 0.9em;
            color: #333;
            border-bottom: 1px solid #e0e8ff;
        }

        .highlights-panel li:last-child { border-bottom: none; }
        .highlights-panel li::before { content: "‚úì "; color: #667eea; font-weight: bold; }

        /* -------------------------------------------------------
           BATCH RESULTS TABLE
        ------------------------------------------------------- */
        .batch-results {
            background: #f8f9ff;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 15px;
            display: none;
        }

        .batch-results h4 {
            color: #667eea;
            font-size: 0.95em;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .batch-results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.86em;
        }

        .batch-results-table th {
            background: #667eea;
            color: white;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
        }

        .batch-results-table th:first-child { border-radius: 4px 0 0 0; }
        .batch-results-table th:last-child  { border-radius: 0 4px 0 0; }

        .batch-results-table td {
            padding: 7px 10px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }

        .batch-results-table tr:last-child td { border-bottom: none; }
        .batch-results-table tr.row-success td { background: #f0fff4; }
        .batch-results-table tr.row-error   td { background: #fff5f5; }

        .badge-ok   { color: #155724; font-weight: 700; }
        .badge-fail { color: #721c24; font-weight: 700; }

        /* -------------------------------------------------------
           PATTERNS LIST
        ------------------------------------------------------- */
        .patterns-list { max-height: 500px; overflow-y: auto; }

        .pattern-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .pattern-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pattern-name { font-weight: 600; color: #333; font-size: 1em; }

        .pattern-type {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            white-space: nowrap;
        }

        .pattern-meta {
            display: flex;
            gap: 20px;
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
        }

        .confidence-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }

        /* -------------------------------------------------------
           HISTORY LIST
        ------------------------------------------------------- */
        .history-list { max-height: 500px; overflow-y: auto; }

        .history-item {
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9ff;
            border-radius: 0 8px 8px 0;
        }

        .history-item .title { font-weight: 600; color: #333; margin-bottom: 5px; }
        .history-item .meta  { font-size: 0.85em; color: #666; }

        .history-item .stats {
            margin-top: 10px;
            display: flex;
            gap: 20px;
            font-size: 0.9em;
        }

        .stat-badge {
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            color: #667eea;
            font-weight: 600;
        }

        /* -------------------------------------------------------
           SPINNER
        ------------------------------------------------------- */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0%   { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* -------------------------------------------------------
           CELEBRATION
        ------------------------------------------------------- */
        .celebration {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            text-align: center;
            z-index: 1000;
            display: none;
            animation: popIn 0.5s ease;
            max-width: 520px;
            width: 90%;
        }

        @keyframes popIn {
            0%   { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .celebration h2    { color: #667eea; font-size: 2em; margin-bottom: 10px; }
        .celebration .icon { font-size: 5em; margin-bottom: 20px; }

        .celebration .highlights {
            text-align: left;
            background: #f8f9ff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .celebration .highlights li {
            list-style: none;
            padding: 3px 0;
            color: #333;
            border-bottom: 1px solid #e8ebff;
        }

        .celebration .highlights li:last-child { border-bottom: none; }
        .celebration .highlights li::before { content: "‚úì "; color: #667eea; }

        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        /* optgroup / option */
        optgroup { font-weight: 700; color: #444; }
        option   { font-weight: 400; color: #333; }

        /* -------------------------------------------------------
           RESPONSIVE
        ------------------------------------------------------- */
        @media (max-width: 768px) {
            .main-grid  { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .header h1  { font-size: 1.8em; }
            .card       { padding: 20px; }
            .header-nav { position: static; justify-content: center; margin-top: 20px; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- ===================================================================
         HEADER
    =================================================================== -->
    <div class="header">
        <div class="header-nav">
            <a href="/" class="nav-btn">&#8592; Back to Main</a>
            <button class="nav-btn" id="downloadBtn" onclick="downloadKnowledge(this)">
                &#128229; Download Knowledge
            </button>
            <button class="nav-btn" id="clearBtn" onclick="clearKnowledgeBase(this)"
                    style="background:#dc3545;color:#fff;border:none;cursor:pointer;">
                &#128465;&#65039; Clear Knowledge Base
            </button>
        </div>
        <h1>&#129504; Knowledge Management</h1>
        <p>Shoulders of Giants - Cumulative Learning System</p>
    </div>

    <!-- ===================================================================
         STATS DASHBOARD
    =================================================================== -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <h3>Total Documents</h3>
            <div class="value" id="totalDocs">0</div>
            <div class="label">ingested forever</div>
        </div>
        <div class="stat-card">
            <h3>Learned Patterns</h3>
            <div class="value" id="totalPatterns">0</div>
            <div class="label">growing stronger</div>
        </div>
        <div class="stat-card">
            <h3>Implementation Manuals</h3>
            <div class="value" id="implDocs">0</div>
            <div class="label">client projects</div>
        </div>
        <div class="stat-card">
            <h3>Lessons Learned</h3>
            <div class="value" id="lessonDocs">0</div>
            <div class="label">consulting wisdom</div>
        </div>
        <div class="stat-card">
            <h3>Contracts</h3>
            <div class="value" id="contractDocs">0</div>
            <div class="label">engagement terms</div>
        </div>
        <div class="stat-card">
            <h3>Assessments</h3>
            <div class="value" id="assessmentDocs">0</div>
            <div class="label">OAF + EAF combined</div>
        </div>
    </div>

    <!-- ===================================================================
         MAIN GRID
    =================================================================== -->
    <div class="main-grid">

        <!-- UPLOAD SECTION -->
        <div class="card">
            <h2>&#128228; Upload Document</h2>

            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error"   id="errorAlert"></div>

            <!--
                uploadZone: clicking anywhere opens the multi-file picker UNLESS
                the click is on a .queue-remove button (handled in JS).
                fileInput sits OUTSIDE the zone to prevent nested-element issues.
                The 'multiple' attribute allows selecting many files at once.
            -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">&#128196;</div>
                <h3>Drag &amp; Drop Documents</h3>
                <p>Word (.docx), Excel (.xlsx), PowerPoint (.pptx), PDF, Text, Markdown, CSV<br>
                   <em>Multiple files supported &#8212; drop several at once</em></p>
                <button class="btn" type="button">Choose Files</button>
            </div>
            <input type="file" id="fileInput" class="file-input" multiple
                   accept=".txt,.md,.pdf,.docx,.doc,.xlsx,.xls,.csv,.json,.pptx,.ppt">

            <div class="progress" id="uploadProgress">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <!-- Highlights panel: shown after single-file ingest -->
            <div class="highlights-panel" id="highlightsPanel">
                <h4>&#128203; What Was Extracted</h4>
                <ul id="highlightsList"></ul>
            </div>

            <!-- Batch results: shown after multi-file ingest -->
            <div class="batch-results" id="batchResults">
                <h4>&#128203; Batch Results</h4>
                <table class="batch-results-table">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Status</th>
                            <th>Patterns</th>
                            <th>Insights</th>
                        </tr>
                    </thead>
                    <tbody id="batchResultsBody"></tbody>
                </table>
            </div>

            <form id="uploadForm" style="margin-top:25px;">

                <div class="form-group">
                    <label for="documentType">Document Type *</label>
                    <select id="documentType" required>
                        <option value="">- Select Document Type -</option>

                        <optgroup label="-- Word Documents --">
                            <option value="contract">Contract / Engagement Agreement</option>
                            <option value="implementation_manual">Implementation Manual</option>
                            <option value="lessons_learned">Lessons Learned</option>
                            <option value="scope_of_work">Scope of Work</option>
                            <option value="general_word">General Word Document</option>
                        </optgroup>

                        <optgroup label="-- PowerPoint Presentations --">
                            <option value="oaf">Operations Assessment (OAF)</option>
                            <option value="eaf">Employee Assessment (EAF)</option>
                            <option value="implementation_ppt">Implementation Presentation</option>
                        </optgroup>

                        <optgroup label="-- Excel Files --">
                            <option value="schedule_pattern">Schedule Pattern File</option>
                            <option value="data_file">Data File (Labor / Overtime / Cost)</option>
                        </optgroup>
                    </select>
                    <div class="hint" id="docTypeHint"></div>
                </div>

                <div class="form-group">
                    <label for="clientName">Client Name (optional)</label>
                    <input type="text" id="clientName"
                           placeholder="e.g., Andersen, ChemDesign, Reckitt">
                </div>

                <div class="form-group">
                    <label for="industry">Industry (optional)</label>
                    <select id="industry">
                        <option value="">- Select Industry -</option>
                        <optgroup label="-- Process Industries --">
                            <option value="chemical">Chemical</option>
                            <option value="pharmaceutical">Pharmaceutical</option>
                            <option value="food_processing">Food Processing</option>
                            <option value="refinery">Refinery / Petroleum</option>
                            <option value="oil_gas">Oil &amp; Gas</option>
                            <option value="plastics">Plastics / Rubber</option>
                            <option value="paper_pulp">Paper / Pulp</option>
                        </optgroup>
                        <optgroup label="-- Manufacturing --">
                            <option value="manufacturing">General Manufacturing</option>
                            <option value="automotive">Automotive</option>
                            <option value="aerospace">Aerospace / Defense</option>
                            <option value="metals">Metals / Steel</option>
                            <option value="electronics">Electronics</option>
                        </optgroup>
                        <optgroup label="-- Extraction &amp; Energy --">
                            <option value="mining">Mining</option>
                            <option value="utilities">Utilities / Power</option>
                        </optgroup>
                        <optgroup label="-- Other --">
                            <option value="distribution">Distribution / Warehousing</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="other">Other</option>
                        </optgroup>
                    </select>
                </div>

                <button type="submit" class="btn" id="submitBtn" style="width:100%;">
                    &#128640; Ingest Document
                </button>
            </form>

            <div class="spinner" id="spinner"></div>
        </div>

        <!-- RECENT ACTIVITY -->
        <div class="card">
            <h2>&#128202; Recent Ingestions</h2>
            <div class="history-list" id="historyList">
                <p style="text-align:center;color:#999;padding:40px;">
                    Loading recent activity...
                </p>
            </div>
        </div>
    </div>

    <!-- LEARNED PATTERNS -->
    <div class="card" style="margin-bottom:30px;">
        <h2>&#127919; Learned Patterns</h2>
        <div class="patterns-list" id="patternsList">
            <p style="text-align:center;color:#999;padding:40px;">
                Loading patterns...
            </p>
        </div>
    </div>

</div><!-- /container -->

<!-- Celebration overlay -->
<div class="overlay"     id="overlay"></div>
<div class="celebration" id="celebration">
    <div class="icon">&#127881;</div>
    <h2 id="celebrationTitle">Knowledge Extracted!</h2>
    <p  id="celebrationMessage"></p>
    <ul class="highlights" id="celebrationHighlights" style="display:none;"></ul>
</div>

<script>
// ===========================================================================
// DOCUMENT TYPE HINTS
// ===========================================================================
var DOC_TYPE_HINTS = {
    'contract':              'Extracts: client name, total fee, payment milestones, engagement weeks',
    'implementation_manual': 'Extracts: schedule patterns, shift lengths, start times, appendices',
    'lessons_learned':       'Extracts: each lesson individually with category, situation, key principle',
    'scope_of_work':         'Extracts: client, weekly deliverables, total cost, pre-project requirements',
    'general_word':          'Extracts: headings, dollar amounts, schedule patterns, section structure',
    'oaf':                   'Extracts: overtime %, headcount, operational metrics (full extractor coming)',
    'eaf':                   'Extracts: satisfaction scores, response rates (full extractor coming)',
    'implementation_ppt':    'Extracts: schedule patterns implemented (full extractor coming)',
    'schedule_pattern':      'Extracts: shift grid data (full extractor coming with Excel sample)',
    'data_file':             'Extracts: labor/overtime/cost data (full extractor coming with Excel sample)'
};

// ===========================================================================
// FILE QUEUE STATE
// Changed February 27, 2026: was single selectedFile, now fileQueue array.
// ===========================================================================
var fileQueue = [];   // Array of File objects

// ===========================================================================
// INITIALIZE
// ===========================================================================
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadHistory();
    loadPatterns();
    setupDragDrop();
    setupFormSubmit();
    setupDocTypeHint();
});

// ===========================================================================
// DOCUMENT TYPE HINT
// ===========================================================================
function setupDocTypeHint() {
    document.getElementById('documentType').addEventListener('change', function() {
        var hint   = DOC_TYPE_HINTS[this.value] || '';
        var hintEl = document.getElementById('docTypeHint');
        hintEl.textContent = hint;
    });
}

// ===========================================================================
// DRAG & DROP SETUP
// Updated February 27, 2026:
//   - drop handler passes ALL files to addFilesToQueue (was files[0] only)
//   - fileInput change handler passes ALL files to addFilesToQueue
//   - zone click listener skips clicks on .queue-remove buttons so that
//     clicking the remove X doesn't accidentally re-open the file picker
// ===========================================================================
function setupDragDrop() {
    var uploadZone = document.getElementById('uploadZone');
    var fileInput  = document.getElementById('fileInput');

    // Click anywhere in the zone = open multi-file picker,
    // EXCEPT when the click target is a remove button.
    uploadZone.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('queue-remove')) return;
        fileInput.value = '';   // reset so same file can be re-selected
        fileInput.click();
    });

    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function() {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            addFilesToQueue(Array.from(e.dataTransfer.files));
        }
    });

    // fileInput.change fires whether 1 or many files were selected
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            addFilesToQueue(Array.from(e.target.files));
        }
    });
}

// ===========================================================================
// FILE QUEUE MANAGEMENT
// Added February 27, 2026.
// ===========================================================================

/**
 * Add an array of File objects to fileQueue.
 * Skips files with unsupported extensions and exact duplicates (name+size).
 */
function addFilesToQueue(files) {
    var allowed = {
        'txt':1,'md':1,'pdf':1,'docx':1,'doc':1,
        'xlsx':1,'xls':1,'csv':1,'json':1,'pptx':1,'ppt':1
    };
    var skipped = 0;

    files.forEach(function(file) {
        var parts = file.name.split('.');
        var ext   = parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
        if (!allowed[ext]) {
            skipped++;
            return;
        }
        // Deduplicate by name + size
        var exists = fileQueue.some(function(f) {
            return f.name === file.name && f.size === file.size;
        });
        if (!exists) {
            fileQueue.push(file);
        }
    });

    if (skipped > 0) {
        showError(skipped + ' file(s) skipped ‚Äî unsupported file type.');
    }

    renderFileQueue();
}

/**
 * Remove a file from the queue by index.
 * stopPropagation prevents the zone click listener from opening the picker.
 */
function removeFromQueue(index, event) {
    if (event) event.stopPropagation();
    fileQueue.splice(index, 1);
    renderFileQueue();
}

/**
 * Re-render the upload zone to show the current file queue.
 * Empty queue ‚Üí show original drop prompt.
 * Non-empty queue ‚Üí show scrollable list with individual remove buttons
 *                   and an "Add More Files" button.
 */
function renderFileQueue() {
    var icons = {
        'pptx':'üìä','ppt':'üìä','xlsx':'üìà','xls':'üìà',
        'pdf':'üìï','docx':'üìù','doc':'üìù',
        'md':'üìÑ','csv':'üìä','txt':'üìÑ','json':'üìÑ'
    };
    var zone = document.getElementById('uploadZone');

    if (fileQueue.length === 0) {
        zone.innerHTML =
            '<div class="upload-icon">&#128196;</div>' +
            '<h3>Drag &amp; Drop Documents</h3>' +
            '<p>Word (.docx), Excel (.xlsx), PowerPoint (.pptx), PDF, Text, Markdown, CSV<br>' +
            '<em>Multiple files supported &#8212; drop several at once</em></p>' +
            '<button class="btn" type="button">Choose Files</button>';

        var sb = document.getElementById('submitBtn');
        if (sb) sb.textContent = '\uD83D\uDE80 Ingest Document';
        return;
    }

    var items = fileQueue.map(function(f, i) {
        var parts = f.name.split('.');
        var ext   = parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
        var icon  = icons[ext] || 'üìÑ';
        var kb    = (f.size / 1024).toFixed(1);
        return '<div class="queue-item">' +
            '<span class="queue-icon">' + icon + '</span>' +
            '<span class="queue-name" title="' + escapeHtml(f.name) + '">' + escapeHtml(f.name) + '</span>' +
            '<span class="queue-size">' + kb + ' KB</span>' +
            '<button class="queue-remove" type="button" onclick="removeFromQueue(' + i + ', event)">\u2715</button>' +
            '</div>';
    }).join('');

    var plural = fileQueue.length !== 1 ? 's' : '';
    zone.innerHTML =
        '<div class="queue-header">' + fileQueue.length + ' file' + plural + ' queued for ingestion</div>' +
        '<div class="queue-list">' + items + '</div>' +
        '<button class="btn btn-sm" type="button" style="margin-top:8px;">\u2795 Add More Files</button>';

    // Update submit button label
    var submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.textContent = fileQueue.length === 1
            ? '\uD83D\uDE80 Ingest Document'
            : '\uD83D\uDE80 Ingest ' + fileQueue.length + ' Documents';
    }
}

// ===========================================================================
// FORM SUBMISSION
// ===========================================================================
function setupFormSubmit() {
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (fileQueue.length === 0) {
            showError('Please select at least one file first');
            return;
        }
        var documentType = document.getElementById('documentType').value;
        if (!documentType) {
            showError('Please select a document type');
            return;
        }
        await uploadDocuments();
    });
}

// ===========================================================================
// UPLOAD ORCHESTRATION
// Routes to single-file (/api/ingest/document) or batch (/api/ingest/batch)
// based on queue size.
// ===========================================================================
async function uploadDocuments() {
    document.getElementById('spinner').style.display        = 'block';
    document.getElementById('submitBtn').disabled            = true;
    document.getElementById('uploadProgress').style.display  = 'block';
    document.getElementById('highlightsPanel').style.display = 'none';
    document.getElementById('batchResults').style.display    = 'none';

    var progress = 0;
    var progressInterval = setInterval(function() {
        progress += 5;
        if (progress <= 90) {
            document.getElementById('progressBar').style.width = progress + '%';
        }
    }, 100);

    try {
        var data;
        if (fileQueue.length === 1) {
            data = await uploadSingle(fileQueue[0]);
        } else {
            data = await uploadBatch();
        }

        clearInterval(progressInterval);
        document.getElementById('progressBar').style.width = '100%';

        setTimeout(function() {
            document.getElementById('spinner').style.display        = 'none';
            document.getElementById('submitBtn').disabled            = false;
            document.getElementById('uploadProgress').style.display  = 'none';
            document.getElementById('progressBar').style.width       = '0%';

            if (data.batch) {
                handleBatchResult(data);
            } else {
                handleSingleResult(data);
            }
        }, 500);

    } catch (error) {
        clearInterval(progressInterval);
        document.getElementById('spinner').style.display        = 'none';
        document.getElementById('submitBtn').disabled            = false;
        document.getElementById('uploadProgress').style.display  = 'none';
        showError('Upload failed: ' + error.message);
    }
}

/** POST single file to /api/ingest/document */
async function uploadSingle(file) {
    var formData = new FormData();
    formData.append('file',          file);
    formData.append('document_type', document.getElementById('documentType').value);
    formData.append('client',        document.getElementById('clientName').value);
    formData.append('industry',      document.getElementById('industry').value);

    var response = await fetch('/api/ingest/document', { method: 'POST', body: formData });
    return await response.json();
}

/** POST all queued files to /api/ingest/batch */
async function uploadBatch() {
    var formData = new FormData();
    fileQueue.forEach(function(f) {
        formData.append('files', f);
    });
    formData.append('document_type', document.getElementById('documentType').value);
    formData.append('client',        document.getElementById('clientName').value);
    formData.append('industry',      document.getElementById('industry').value);

    var response = await fetch('/api/ingest/batch', { method: 'POST', body: formData });
    return await response.json();
}

// ===========================================================================
// RESULT HANDLERS
// ===========================================================================
function handleSingleResult(data) {
    if (data.success) {
        showSuccess(data.message || 'Document ingested successfully');
        showHighlights(data.highlights || []);
        showCelebration(data);
        resetForm();
        loadStats();
        loadHistory();
        loadPatterns();
    } else {
        showError(data.error || 'Upload failed');
    }
}

function handleBatchResult(data) {
    if (data.success_count > 0) {
        showSuccess(
            data.success_count + ' of ' + data.total_files + ' files ingested. ' +
            data.total_patterns_extracted + ' patterns, ' +
            data.total_insights_extracted + ' insights extracted.'
        );
    }
    if (data.error_count > 0) {
        showError(data.error_count + ' file(s) failed ‚Äî see results table below.');
    }
    showBatchResults(data.results || []);
    showCelebrationBatch(data);
    resetForm();
    loadStats();
    loadHistory();
    loadPatterns();
}

// ===========================================================================
// HIGHLIGHTS PANEL (single file)
// ===========================================================================
function showHighlights(highlights) {
    var panel = document.getElementById('highlightsPanel');
    var list  = document.getElementById('highlightsList');
    if (!highlights || highlights.length === 0) {
        panel.style.display = 'none';
        return;
    }
    list.innerHTML = highlights.map(function(h) {
        return '<li>' + escapeHtml(h) + '</li>';
    }).join('');
    panel.style.display = 'block';
}

// ===========================================================================
// BATCH RESULTS TABLE
// ===========================================================================
function showBatchResults(results) {
    var panel = document.getElementById('batchResults');
    var tbody = document.getElementById('batchResultsBody');

    if (!results || results.length === 0) {
        panel.style.display = 'none';
        return;
    }

    tbody.innerHTML = results.map(function(r) {
        var rowClass = r.success ? 'row-success' : 'row-error';
        var status = r.success
            ? '<span class="badge-ok">\u2713 OK</span>'
            : '<span class="badge-fail">\u2717 ' + escapeHtml(r.error || 'failed') + '</span>';
        var patterns = r.success ? (r.patterns_extracted || 0) : '&mdash;';
        var insights = r.success ? (r.insights_extracted || 0) : '&mdash;';
        return '<tr class="' + rowClass + '">' +
            '<td>' + escapeHtml(r.filename || '') + '</td>' +
            '<td>' + status + '</td>' +
            '<td>' + patterns + '</td>' +
            '<td>' + insights + '</td>' +
            '</tr>';
    }).join('');

    panel.style.display = 'block';
}

// ===========================================================================
// CELEBRATION POPUPS
// ===========================================================================
function showCelebration(data) {
    document.getElementById('celebrationTitle').textContent = 'Knowledge Extracted!';
    document.getElementById('celebrationMessage').innerHTML =
        (data.patterns_extracted || 0) + ' patterns extracted &nbsp; ' +
        '\uD83D\uDCA1 ' + (data.insights_extracted || 0) + ' insights captured &nbsp; ' +
        '\uD83D\uDCCA ' + (data.total_patterns || 0) + ' total patterns in knowledge base';

    var hl  = document.getElementById('celebrationHighlights');
    var hls = data.highlights || [];
    if (hls.length > 0) {
        hl.innerHTML = hls.map(function(h) { return '<li>' + escapeHtml(h) + '</li>'; }).join('');
        hl.style.display = 'block';
    } else {
        hl.style.display = 'none';
    }
    _showCelebrationPopup();
}

function showCelebrationBatch(data) {
    if (!data.success_count || data.success_count === 0) return;
    document.getElementById('celebrationTitle').textContent =
        data.success_count + ' Files Ingested!';
    document.getElementById('celebrationMessage').innerHTML =
        '\uD83D\uDCC1 ' + data.success_count + ' of ' + data.total_files + ' files succeeded &nbsp; ' +
        '\uD83D\uDCCA ' + (data.total_patterns_extracted || 0) + ' patterns extracted &nbsp; ' +
        '\uD83D\uDCA1 ' + (data.total_insights_extracted || 0) + ' insights captured';
    document.getElementById('celebrationHighlights').style.display = 'none';
    _showCelebrationPopup();
}

function _showCelebrationPopup() {
    document.getElementById('overlay').style.display     = 'block';
    document.getElementById('celebration').style.display = 'block';
    setTimeout(function() {
        document.getElementById('overlay').style.display     = 'none';
        document.getElementById('celebration').style.display = 'none';
    }, 4000);
}

// ===========================================================================
// RESET FORM
// ===========================================================================
function resetForm() {
    fileQueue = [];
    document.getElementById('uploadForm').reset();
    document.getElementById('docTypeHint').textContent = '';
    document.getElementById('uploadZone').innerHTML =
        '<div class="upload-icon">&#128196;</div>' +
        '<h3>Drag &amp; Drop Documents</h3>' +
        '<p>Word (.docx), Excel (.xlsx), PowerPoint (.pptx), PDF, Text, Markdown, CSV<br>' +
        '<em>Multiple files supported &#8212; drop several at once</em></p>' +
        '<button class="btn" type="button">Choose Files</button>';
    var sb = document.getElementById('submitBtn');
    if (sb) sb.textContent = '\uD83D\uDE80 Ingest Document';
}

// ===========================================================================
// STATS / HISTORY / PATTERNS
// ===========================================================================
async function loadStats() {
    try {
        var response = await fetch('/api/ingest/status');
        var data = await response.json();
        if (data.success) {
            var stats  = data.stats;
            var byType = stats.by_document_type || {};
            document.getElementById('totalDocs').textContent     = stats.total_extracts;
            document.getElementById('totalPatterns').textContent  = stats.total_patterns;
            document.getElementById('implDocs').textContent       = byType.implementation_manual || 0;
            document.getElementById('lessonDocs').textContent     = byType.lessons_learned || 0;
            document.getElementById('contractDocs').textContent   =
                (byType.contract || 0) + (byType.proposal || 0);
            document.getElementById('assessmentDocs').textContent =
                (byType.oaf || 0) + (byType.eaf || 0);
        }
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

async function loadHistory() {
    try {
        var response = await fetch('/api/ingest/history?limit=10');
        var data = await response.json();
        if (data.success) {
            var historyList = document.getElementById('historyList');
            if (data.history.length === 0) {
                historyList.innerHTML =
                    '<p style="text-align:center;color:#999;padding:40px;">No documents ingested yet</p>';
                return;
            }
            historyList.innerHTML = data.history.map(function(item) {
                return '<div class="history-item">' +
                    '<div class="title">' + escapeHtml(item.document_name) + '</div>' +
                    '<div class="meta">' + escapeHtml(item.document_type) + ' &bull; ' +
                    new Date(item.ingested_at).toLocaleString() + '</div>' +
                    '<div class="stats">' +
                    '<span class="stat-badge">\uD83D\uDCCA ' + item.patterns_extracted + ' patterns</span>' +
                    '<span class="stat-badge">\uD83D\uDCA1 ' + item.insights_extracted + ' insights</span>' +
                    '</div></div>';
            }).join('');
        }
    } catch (error) {
        console.error('Failed to load history:', error);
    }
}

async function loadPatterns() {
    try {
        var response = await fetch('/api/ingest/patterns?limit=30');
        var data = await response.json();
        if (data.success) {
            var patternsList = document.getElementById('patternsList');
            if (data.patterns.length === 0) {
                patternsList.innerHTML =
                    '<p style="text-align:center;color:#999;padding:40px;">No patterns learned yet</p>';
                return;
            }
            patternsList.innerHTML = data.patterns.map(function(pattern) {
                var pct = (pattern.confidence * 100).toFixed(1);
                var docs = pattern.supporting_documents;
                return '<div class="pattern-item">' +
                    '<div class="pattern-header">' +
                    '<span class="pattern-name">' + escapeHtml(pattern.pattern_name || '') + '</span>' +
                    '<span class="pattern-type">' + escapeHtml(pattern.pattern_type || '') + '</span>' +
                    '</div>' +
                    '<div class="confidence-bar"><div class="confidence-fill" style="width:' + pct + '%"></div></div>' +
                    '<div class="pattern-meta">' +
                    '<span>\uD83D\uDCAA ' + pct + '% confidence</span>' +
                    '<span>\uD83D\uDCDA ' + docs + ' doc' + (docs !== 1 ? 's' : '') + '</span>' +
                    '</div></div>';
            }).join('');
        }
    } catch (error) {
        console.error('Failed to load patterns:', error);
    }
}

// ===========================================================================
// DOWNLOAD / CLEAR
// ===========================================================================
function downloadKnowledge(btn) {
    btn.disabled = true;
    btn.innerHTML = 'Preparing download...';
    window.location.href = '/api/ingest/export';
    setTimeout(function() {
        btn.disabled = false;
        btn.innerHTML = '&#128229; Download Knowledge';
    }, 3000);
}

async function clearKnowledgeBase(btn) {
    var first = confirm(
        '\u26A0\uFE0F Clear Knowledge Base?\n\n' +
        'This will permanently delete ALL ingested documents, patterns, and history.\n\n' +
        'You will need to re-upload your documents.\n\nClick OK to continue.'
    );
    if (!first) return;

    var second = confirm(
        '\uD83D\uDED1 FINAL CONFIRMATION\n\n' +
        'Are you absolutely sure?\n\n' +
        'All knowledge extracts and learned patterns will be deleted.\n\n' +
        'Click OK to permanently clear the knowledge base.'
    );
    if (!second) return;

    btn.disabled = true;
    btn.innerHTML = '\u23F3 Clearing...';

    try {
        var response = await fetch('/api/ingest/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirm: 'CLEAR' })
        });
        var data = await response.json();

        if (data.success) {
            var deleted = data.deleted || {};
            alert(
                '\u2705 Knowledge base cleared!\n\n' +
                'Documents deleted: '  + (deleted.knowledge_extracts || 0) + '\n' +
                'Patterns deleted: '   + (deleted.learned_patterns   || 0) + '\n' +
                'History deleted: '    + (deleted.ingestion_log      || 0) + '\n\n' +
                'You can now re-upload your documents.'
            );
            loadStats();
            loadHistory();
        } else {
            alert('\u274C Clear failed: ' + (data.error || 'Unknown error'));
        }
    } catch (err) {
        alert('\u274C Request failed: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '&#128465;&#65039; Clear Knowledge Base';
    }
}

// ===========================================================================
// UTILITY
// ===========================================================================
function showSuccess(message) {
    var el = document.getElementById('successAlert');
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(function() { el.style.display = 'none'; }, 8000);
}

function showError(message) {
    var el = document.getElementById('errorAlert');
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(function() { el.style.display = 'none'; }, 8000);
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g,  '&amp;')
        .replace(/</g,  '&lt;')
        .replace(/>/g,  '&gt;')
        .replace(/"/g,  '&quot;');
}
</script>
</body>
</html>

<!-- I did no harm and this file is not truncated -->
